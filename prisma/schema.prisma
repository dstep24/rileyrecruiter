generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id              String                   @id @default(uuid())
  name            String
  slug            String                   @unique
  status          TenantStatus             @default(ONBOARDING)
  config          Json                     @default("{}")
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  candidates      Candidate[]
  conversations   Conversation[]
  criteria        Criteria[]
  documents       Document[]
  guidelines      Guidelines[]
  integrations    Integration[]
  jobRequisitions JobRequisition[]
  tasks           Task[]
  teleoperators   TeleoperatorAssignment[]

  @@map("tenants")
}

model Guidelines {
  id              String           @id @default(uuid())
  tenantId        String
  version         Int
  status          GuidelinesStatus @default(DRAFT)
  workflows       Json             @default("[]")
  templates       Json             @default("[]")
  decisionTrees   Json             @default("[]")
  constraints     Json             @default("[]")
  createdBy       CreatedBy
  parentVersionId String?
  changelog       String?
  effectiveFrom   DateTime?
  effectiveUntil  DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  parentVersion   Guidelines?      @relation("GuidelinesVersionHistory", fields: [parentVersionId], references: [id])
  childVersions   Guidelines[]     @relation("GuidelinesVersionHistory")
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, version])
  @@index([tenantId, status])
  @@map("guidelines")
}

model Criteria {
  id                String         @id @default(uuid())
  tenantId          String
  version           Int
  status            CriteriaStatus @default(DRAFT)
  qualityStandards  Json           @default("[]")
  evaluationRubrics Json           @default("[]")
  successMetrics    Json           @default("[]")
  failurePatterns   Json           @default("[]")
  createdBy         CreatedBy
  parentVersionId   String?
  changelog         String?
  effectiveFrom     DateTime?
  effectiveUntil    DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  parentVersion     Criteria?      @relation("CriteriaVersionHistory", fields: [parentVersionId], references: [id])
  childVersions     Criteria[]     @relation("CriteriaVersionHistory")
  tenant            Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, version])
  @@index([tenantId, status])
  @@map("criteria")
}

model JobRequisition {
  id              String            @id @default(uuid())
  tenantId        String
  externalId      String?
  title           String
  description     String
  requirements    Json              @default("[]")
  preferredSkills Json              @default("[]")
  location        String?
  locationType    LocationType      @default(UNSPECIFIED)
  salaryRange     Json?
  status          RequisitionStatus @default(OPEN)
  priority        Priority          @default(MEDIUM)
  hiringManager   String?
  interviewStages Json              @default("[]")
  openedAt        DateTime          @default(now())
  closedAt        DateTime?
  targetFillDate  DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  candidates      Candidate[]
  tenant          Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sourcingTasks   Task[]            @relation("RequisitionTasks")
  assessments     PreScreeningTemplate[]

  @@unique([tenantId, externalId])
  @@index([tenantId, status])
  @@map("job_requisitions")
}

model Candidate {
  id              String          @id @default(uuid())
  tenantId        String
  requisitionId   String?
  externalIds     Json            @default("[]")
  firstName       String
  lastName        String
  email           String
  phone           String?
  linkedInUrl     String?
  resumeUrl       String?
  profileData     Json            @default("{}")
  stage           PipelineStage   @default(SOURCED)
  stageHistory    Json            @default("[]")
  overallScore    Float?
  scoreBreakdown  Json?
  flags           Json            @default("[]")
  source          String?
  status          CandidateStatus @default(ACTIVE)
  rejectionReason String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  assessments     Assessment[]
  requisition     JobRequisition? @relation(fields: [requisitionId], references: [id])
  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversations   Conversation[]
  interactions    Interaction[]

  @@index([tenantId, stage])
  @@index([tenantId, email])
  @@map("candidates")
}

model Conversation {
  id               String             @id @default(uuid())
  tenantId         String
  candidateId      String
  channel          Channel
  externalThreadId String?
  subject          String?
  status           ConversationStatus @default(ACTIVE)
  lastMessageAt    DateTime?
  currentIntent    String?
  intentConfidence Float?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  candidate        Candidate          @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  tenant           Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages         Message[]

  @@index([tenantId, candidateId])
  @@index([tenantId, status])
  @@map("conversations")
}

model Message {
  id             String           @id @default(uuid())
  conversationId String
  direction      MessageDirection
  content        String
  contentType    String           @default("text")
  senderType     SenderType
  sentAt         DateTime?
  deliveredAt    DateTime?
  readAt         DateTime?
  taskId         String?
  createdAt      DateTime         @default(now())
  conversation   Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("messages")
}

model Assessment {
  id            String         @id @default(uuid())
  candidateId   String
  requisitionId String?
  type          AssessmentType
  dimension     String
  score         Float
  maxScore      Float          @default(100)
  confidence    Float          @default(1.0)
  evidence      Json           @default("[]")
  reasoning     String?
  assessedBy    CreatedBy
  assessedAt    DateTime       @default(now())
  createdAt     DateTime       @default(now())
  candidate     Candidate      @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@map("assessments")
}

model Interaction {
  id          String          @id @default(uuid())
  candidateId String
  type        InteractionType
  channel     Channel?
  summary     String
  details     Json            @default("{}")
  performedBy CreatedBy
  performedAt DateTime        @default(now())
  taskId      String?
  createdAt   DateTime        @default(now())
  candidate   Candidate       @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId, performedAt])
  @@map("interactions")
}

model Task {
  id               String            @id @default(uuid())
  tenantId         String
  requisitionId    String?
  type             TaskType
  payload          Json
  innerLoopId      String?
  iterations       Int               @default(0)
  converged        Boolean           @default(false)
  status           TaskStatus        @default(DRAFT)
  effectful        Boolean           @default(false)
  escalationReason EscalationReason?
  approvedBy       String?
  approvedAt       DateTime?
  rejectedBy       String?
  rejectedAt       DateTime?
  rejectionReason  String?
  executedAt       DateTime?
  executionResult  Json?
  executionError   String?
  priority         Priority          @default(MEDIUM)
  scheduledFor     DateTime?
  expiresAt        DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  requisition      JobRequisition?   @relation("RequisitionTasks", fields: [requisitionId], references: [id])
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([tenantId, type])
  @@index([status, scheduledFor])
  @@map("tasks")
}

model TeleoperatorAssignment {
  id        String           @id @default(uuid())
  tenantId  String
  userId    String
  email     String
  name      String
  role      TeleoperatorRole @default(REVIEWER)
  status    AssignmentStatus @default(ACTIVE)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@map("teleoperator_assignments")
}

model Integration {
  id          String            @id @default(uuid())
  tenantId    String
  type        IntegrationType
  provider    String
  credentials Json              @default("{}")
  config      Json              @default("{}")
  status      IntegrationStatus @default(PENDING)
  lastSyncAt  DateTime?
  lastError   String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  tenant      Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, type, provider])
  @@map("integrations")
}

model Document {
  id                String         @id @default(uuid())
  tenantId          String
  type              DocumentType
  name              String
  mimeType          String
  storageUrl        String
  status            DocumentStatus @default(PENDING)
  processedAt       DateTime?
  extractedContent  Json?
  extractedPatterns Json?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  tenant            Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, type])
  @@map("documents")
}

model InnerLoopRun {
  id                     String          @id @default(uuid())
  tenantId               String
  taskType               TaskType
  contextSnapshot        Json
  status                 InnerLoopStatus @default(RUNNING)
  iterations             Int             @default(0)
  maxIterations          Int             @default(5)
  converged              Boolean         @default(false)
  finalScore             Float?
  convergenceThreshold   Float           @default(0.8)
  startGuidelinesVersion Int
  endGuidelinesVersion   Int?
  guidelinesUpdates      Json            @default("[]")
  outputTaskId           String?
  startedAt              DateTime        @default(now())
  completedAt            DateTime?
  createdAt              DateTime        @default(now())

  @@index([tenantId, createdAt])
  @@index([status])
  @@map("inner_loop_runs")
}

model RileyConversation {
  id                  String                  @id @default(uuid())
  chatId              String                  @unique
  candidateProviderId String
  candidateName       String?
  candidateTitle      String?
  candidateCompany    String?
  candidateProfileUrl String?
  jobRequisitionId    String?
  jobTitle            String?
  stage               RileyConversationStage  @default(INITIAL_OUTREACH)
  status              RileyConversationStatus @default(ACTIVE)
  messageCount        Int                     @default(1)
  lastMessageAt       DateTime                @default(now())
  lastMessageBy       LastMessageBy           @default(RILEY)
  schedulingRequested Boolean                 @default(false)
  scheduledCallAt     DateTime?
  isEscalated         Boolean                 @default(false)
  escalationReason    String?
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  messages            RileyMessage[]

  // Link to outreach that started this conversation
  outreachTracker     OutreachTracker?

  @@index([chatId])
  @@index([candidateProviderId])
  @@index([status, stage])
  @@map("riley_conversations")
}

model RileyMessage {
  id               String            @id @default(uuid())
  conversationId   String
  role             MessageRole
  content          String
  unipileMessageId String?
  isAutoGenerated  Boolean           @default(false)
  createdAt        DateTime          @default(now())
  conversation     RileyConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("riley_messages")
}

// =============================================================================
// OUTREACH TEMPLATES
// =============================================================================

model OutreachTemplate {
  id          String   @id @default(uuid())
  tenantId    String

  name        String                    // "High-Converting Engineer Outreach"
  description String?                   // When to use this template
  category    OutreachCategory          // INITIAL, FOLLOW_UP, REFERRAL, etc.
  channel     OutreachChannel           // LINKEDIN_CONNECTION, LINKEDIN_INMAIL, EMAIL
  roleType    String?                   // "engineering", "sales", etc.

  // Template content
  subjectTemplate String?               // For InMail/email: "{{roleTitle}} | {{arr}} | {{investors}}"
  messageTemplate String                // The message with placeholders

  // Metadata
  brandVoice  String   @default("professional-warm")
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)  // Default template for this category/channel

  // Usage tracking
  useCount    Int      @default(0)
  responseRate Float?                   // Tracked response rate for this template

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId, category, channel])
  @@index([tenantId, isActive])
  @@map("outreach_templates")
}

enum OutreachCategory {
  INITIAL_OUTREACH          // First contact
  FOLLOW_UP_1               // First follow-up (3-5 days)
  FOLLOW_UP_2               // Second follow-up (7 days)
  FOLLOW_UP_3               // Third/final follow-up
  REFERRAL_ASK              // Asking for referrals
  RE_ENGAGEMENT             // Re-engaging cold candidates
  WARM_INTRO                // When you have a mutual connection
  POST_INTERVIEW            // After interview feedback
}

enum OutreachChannel {
  LINKEDIN_CONNECTION       // 300 char limit
  LINKEDIN_INMAIL           // 1900 char limit
  EMAIL                     // No practical limit
}

// =============================================================================
// PRE-SCREENING ASSESSMENT MODELS
// =============================================================================

model PreScreeningTemplate {
  id               String   @id @default(uuid())
  tenantId         String

  name             String                    // "Senior Engineer Screen"
  description      String?
  roleType         String?                   // "engineering", "sales", etc.
  isActive         Boolean  @default(true)

  // Link to job requisition (optional - if set, this is a job-specific assessment)
  jobRequisitionId String?
  jobRequisition   JobRequisition? @relation(fields: [jobRequisitionId], references: [id])

  // Whether this was AI-generated from the job description
  isAutoGenerated  Boolean  @default(false)

  questions        PreScreeningQuestion[]
  responses        PreScreeningResponse[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([tenantId, isActive])
  @@index([jobRequisitionId])
  @@map("pre_screening_templates")
}

model PreScreeningQuestion {
  id            String       @id @default(uuid())
  templateId    String

  questionText  String                    // "Do you require visa sponsorship?"
  questionType  QuestionType              // MULTIPLE_CHOICE, TEXT, YES_NO, SCALE
  options       Json?                     // ["Yes", "No", "Not sure"]
  isRequired    Boolean      @default(true)
  orderIndex    Int

  // Scoring config
  scoringWeight Int          @default(1)
  idealAnswer   String?                   // For auto-scoring

  template      PreScreeningTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  answers       PreScreeningAnswer[]

  @@index([templateId, orderIndex])
  @@map("pre_screening_questions")
}

model PreScreeningResponse {
  id              String         @id @default(uuid())
  templateId      String
  conversationId  String                  // Links to RileyConversation

  candidateName   String?
  candidateEmail  String?

  status          ResponseStatus @default(PENDING)
  submittedAt     DateTime?

  // AI Scoring Results
  aiScore         Int?                    // 0-100
  aiSummary       String?                 // AI-generated summary
  aiFlags         Json?                   // ["sponsorship_needed", "salary_mismatch"]

  // Token security
  accessToken     String         @unique  // JWT for secure access
  expiresAt       DateTime

  template        PreScreeningTemplate @relation(fields: [templateId], references: [id])
  answers         PreScreeningAnswer[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([conversationId])
  @@index([accessToken])
  @@map("pre_screening_responses")
}

model PreScreeningAnswer {
  id          String   @id @default(uuid())
  responseId  String
  questionId  String

  answerText  String
  answerValue Json?                     // For structured answers

  response    PreScreeningResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
  question    PreScreeningQuestion @relation(fields: [questionId], references: [id])

  @@unique([responseId, questionId])
  @@map("pre_screening_answers")
}

// =============================================================================
// ENUMS
// =============================================================================

enum QuestionType {
  MULTIPLE_CHOICE
  TEXT
  YES_NO
  SCALE
  DATE
}

enum ResponseStatus {
  PENDING
  STARTED
  COMPLETED
  EXPIRED
}

enum TenantStatus {
  ONBOARDING
  SHADOW_MODE
  SUPERVISED
  AUTONOMOUS
  PAUSED
}

enum GuidelinesStatus {
  DRAFT
  ACTIVE
  ARCHIVED
  REJECTED
}

enum CreatedBy {
  AGENT
  TELEOPERATOR
  SYSTEM
}

enum CriteriaStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum RequisitionStatus {
  DRAFT
  OPEN
  ON_HOLD
  CLOSED_FILLED
  CLOSED_CANCELLED
}

enum LocationType {
  ONSITE
  REMOTE
  HYBRID
  UNSPECIFIED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum PipelineStage {
  SOURCED
  CONTACTED
  RESPONDED
  SCREENING
  INTERVIEW_SCHEDULED
  INTERVIEWING
  OFFER_EXTENDED
  OFFER_ACCEPTED
  HIRED
  REJECTED
  WITHDRAWN
}

enum CandidateStatus {
  ACTIVE
  ON_HOLD
  ARCHIVED
  DO_NOT_CONTACT
}

enum Channel {
  EMAIL
  LINKEDIN
  SMS
  PHONE
  IN_APP
}

enum ConversationStatus {
  ACTIVE
  WAITING_RESPONSE
  COMPLETED
  ARCHIVED
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum SenderType {
  CANDIDATE
  AGENT
  TELEOPERATOR
}

enum AssessmentType {
  RESUME_SCREEN
  SKILLS_MATCH
  EXPERIENCE_FIT
  CULTURE_FIT
  COMMUNICATION
  TECHNICAL_SCREEN
}

enum InteractionType {
  OUTREACH_SENT
  RESPONSE_RECEIVED
  FOLLOW_UP_SENT
  INTERVIEW_SCHEDULED
  INTERVIEW_COMPLETED
  FEEDBACK_PROVIDED
  STAGE_CHANGED
  NOTE_ADDED
  ASSESSMENT_COMPLETED
}

enum TaskType {
  SEND_EMAIL
  SEND_LINKEDIN_MESSAGE
  SEND_FOLLOW_UP
  SEARCH_CANDIDATES
  IMPORT_CANDIDATE
  SCREEN_RESUME
  GENERATE_ASSESSMENT
  SCHEDULE_INTERVIEW
  SEND_REMINDER
  UPDATE_ATS_STATUS
  SYNC_CANDIDATE
  PREPARE_OFFER
  SEND_OFFER
  UPDATE_GUIDELINES
  GENERATE_REPORT
}

enum TaskStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  EXECUTING
  COMPLETED
  FAILED
  REJECTED
  CANCELLED
  EXPIRED
}

enum EscalationReason {
  SENSITIVE_COMMUNICATION
  BUDGET_DISCUSSION
  OFFER_NEGOTIATION
  CANDIDATE_COMPLAINT
  EDGE_CASE
  LOW_CONFIDENCE
  POLICY_VIOLATION_RISK
  FIRST_CONTACT_VIP
  MANUAL_REVIEW_REQUESTED
}

enum TeleoperatorRole {
  REVIEWER
  EDITOR
  ADMIN
}

enum AssignmentStatus {
  ACTIVE
  INACTIVE
}

enum IntegrationType {
  ATS
  EMAIL
  CALENDAR
  LINKEDIN
  JOB_BOARD
}

enum IntegrationStatus {
  PENDING
  CONNECTED
  ERROR
  DISCONNECTED
}

enum DocumentType {
  JOB_DESCRIPTION
  COMPANY_INFO
  BRAND_GUIDELINES
  PAST_PLACEMENT
  EMAIL_TEMPLATE
  RECRUITING_PLAYBOOK
  INTERVIEW_GUIDE
}

enum DocumentStatus {
  PENDING
  PROCESSING
  PROCESSED
  FAILED
}

enum InnerLoopStatus {
  RUNNING
  CONVERGED
  MAX_ITERATIONS_REACHED
  ERROR
  CANCELLED
}

enum RileyConversationStage {
  INITIAL_OUTREACH
  AWAITING_RESPONSE
  IN_CONVERSATION
  ASSESSMENT_SENT           // Assessment link sent to candidate
  ASSESSMENT_COMPLETE       // Candidate completed assessment
  SCHEDULING
  SCHEDULED
  FOLLOW_UP
  CLOSED_INTERESTED
  CLOSED_NOT_INTERESTED
  CLOSED_NO_RESPONSE
}

enum RileyConversationStatus {
  ACTIVE
  PAUSED
  ESCALATED
  COMPLETED
}

enum LastMessageBy {
  RILEY
  CANDIDATE
  TELEOPERATOR
}

enum MessageRole {
  RILEY
  CANDIDATE
  TELEOPERATOR
}
