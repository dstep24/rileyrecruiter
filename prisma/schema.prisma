// Riley Recruiter - Prisma Schema
// Two-Loop Paradigm: Autonomous recruiting agent with teleoperator oversight

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// MULTI-TENANT FOUNDATION
// ============================================================================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  status    TenantStatus @default(ONBOARDING)
  config    Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  guidelines       Guidelines[]
  criteria         Criteria[]
  jobRequisitions  JobRequisition[]
  candidates       Candidate[]
  conversations    Conversation[]
  tasks            Task[]
  teleoperators    TeleoperatorAssignment[]
  integrations     Integration[]
  documents        Document[]

  @@map("tenants")
}

enum TenantStatus {
  ONBOARDING      // Document ingestion phase
  SHADOW_MODE     // Learning from human recruiters
  SUPERVISED      // 100% approval required
  AUTONOMOUS      // Escalation-only supervision
  PAUSED          // Temporarily disabled
}

// ============================================================================
// GUIDELINES (G) - "How to Recruit"
// Agent CAN update these autonomously in the inner loop
// ============================================================================

model Guidelines {
  id              String   @id @default(uuid())
  tenantId        String
  version         Int
  status          GuidelinesStatus @default(DRAFT)

  // The actual guidelines content (structured JSON)
  workflows       Json     @default("[]")   // WorkflowGuideline[]
  templates       Json     @default("[]")   // TemplateGuideline[]
  decisionTrees   Json     @default("[]")   // DecisionTree[]
  constraints     Json     @default("[]")   // Constraint[]

  // Metadata
  createdBy       CreatedBy
  parentVersionId String?
  changelog       String?
  effectiveFrom   DateTime?
  effectiveUntil  DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentVersion   Guidelines? @relation("GuidelinesVersionHistory", fields: [parentVersionId], references: [id])
  childVersions   Guidelines[] @relation("GuidelinesVersionHistory")

  @@unique([tenantId, version])
  @@index([tenantId, status])
  @@map("guidelines")
}

enum GuidelinesStatus {
  DRAFT           // Created by inner loop, pending review
  ACTIVE          // Currently in use
  ARCHIVED        // Superseded by newer version
  REJECTED        // Rejected by teleoperator
}

enum CreatedBy {
  AGENT           // Created by inner loop
  TELEOPERATOR    // Created by human
  SYSTEM          // Created during onboarding
}

// ============================================================================
// CRITERIA (C) - "What Good Recruiting Looks Like"
// Agent CANNOT update these - only teleoperators can (prevents reward hacking)
// ============================================================================

model Criteria {
  id              String   @id @default(uuid())
  tenantId        String
  version         Int
  status          CriteriaStatus @default(DRAFT)

  // The actual criteria content (structured JSON)
  qualityStandards   Json  @default("[]")   // QualityStandard[]
  evaluationRubrics  Json  @default("[]")   // EvaluationRubric[]
  successMetrics     Json  @default("[]")   // SuccessMetric[]
  failurePatterns    Json  @default("[]")   // FailurePattern[]

  // Metadata
  createdBy       CreatedBy
  parentVersionId String?
  changelog       String?
  effectiveFrom   DateTime?
  effectiveUntil  DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentVersion   Criteria? @relation("CriteriaVersionHistory", fields: [parentVersionId], references: [id])
  childVersions   Criteria[] @relation("CriteriaVersionHistory")

  @@unique([tenantId, version])
  @@index([tenantId, status])
  @@map("criteria")
}

enum CriteriaStatus {
  DRAFT           // Pending teleoperator approval
  ACTIVE          // Currently in use
  ARCHIVED        // Superseded by newer version
}

// ============================================================================
// JOB REQUISITIONS
// ============================================================================

model JobRequisition {
  id              String   @id @default(uuid())
  tenantId        String
  externalId      String?  // ID in external ATS

  // Core fields
  title           String
  description     String
  requirements    Json     @default("[]")
  preferredSkills Json     @default("[]")
  location        String?
  locationType    LocationType @default(UNSPECIFIED)
  salaryRange     Json?    // { min: number, max: number, currency: string }

  // Status
  status          RequisitionStatus @default(OPEN)
  priority        Priority @default(MEDIUM)

  // Hiring process
  hiringManager   String?
  interviewStages Json     @default("[]")

  // Metadata
  openedAt        DateTime @default(now())
  closedAt        DateTime?
  targetFillDate  DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  candidates      Candidate[]
  sourcingTasks   Task[]   @relation("RequisitionTasks")

  @@unique([tenantId, externalId])
  @@index([tenantId, status])
  @@map("job_requisitions")
}

enum RequisitionStatus {
  DRAFT
  OPEN
  ON_HOLD
  CLOSED_FILLED
  CLOSED_CANCELLED
}

enum LocationType {
  ONSITE
  REMOTE
  HYBRID
  UNSPECIFIED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============================================================================
// CANDIDATES
// ============================================================================

model Candidate {
  id              String   @id @default(uuid())
  tenantId        String
  requisitionId   String?

  // External IDs (for deduplication across sources)
  externalIds     Json     @default("[]")   // { source: string, id: string }[]

  // Profile
  firstName       String
  lastName        String
  email           String
  phone           String?
  linkedInUrl     String?
  resumeUrl       String?

  // Parsed profile data
  profileData     Json     @default("{}")   // Skills, experience, education

  // Pipeline
  stage           PipelineStage @default(SOURCED)
  stageHistory    Json     @default("[]")   // { stage, timestamp, reason }[]

  // Scoring
  overallScore    Float?
  scoreBreakdown  Json?    // { dimension: string, score: number }[]

  // Flags
  flags           Json     @default("[]")   // CandidateFlag[]
  source          String?  // How they were sourced

  // Status
  status          CandidateStatus @default(ACTIVE)
  rejectionReason String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  requisition     JobRequisition? @relation(fields: [requisitionId], references: [id])
  conversations   Conversation[]
  assessments     Assessment[]
  interactions    Interaction[]

  @@index([tenantId, stage])
  @@index([tenantId, email])
  @@map("candidates")
}

enum PipelineStage {
  SOURCED
  CONTACTED
  RESPONDED
  SCREENING
  INTERVIEW_SCHEDULED
  INTERVIEWING
  OFFER_EXTENDED
  OFFER_ACCEPTED
  HIRED
  REJECTED
  WITHDRAWN
}

enum CandidateStatus {
  ACTIVE
  ON_HOLD
  ARCHIVED
  DO_NOT_CONTACT
}

// ============================================================================
// CONVERSATIONS
// ============================================================================

model Conversation {
  id              String   @id @default(uuid())
  tenantId        String
  candidateId     String

  // Conversation metadata
  channel         Channel
  externalThreadId String? // Thread ID in email/LinkedIn
  subject         String?

  // State
  status          ConversationStatus @default(ACTIVE)
  lastMessageAt   DateTime?

  // Intent classification (for routing)
  currentIntent   String?
  intentConfidence Float?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  candidate       Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  messages        Message[]

  @@index([tenantId, candidateId])
  @@index([tenantId, status])
  @@map("conversations")
}

enum Channel {
  EMAIL
  LINKEDIN
  SMS
  PHONE
  IN_APP
}

enum ConversationStatus {
  ACTIVE
  WAITING_RESPONSE
  COMPLETED
  ARCHIVED
}

model Message {
  id              String   @id @default(uuid())
  conversationId  String

  // Message content
  direction       MessageDirection
  content         String
  contentType     String   @default("text")

  // Metadata
  senderType      SenderType
  sentAt          DateTime?
  deliveredAt     DateTime?
  readAt          DateTime?

  // For outbound messages
  taskId          String?  // Link to the task that created this

  createdAt       DateTime @default(now())

  // Relations
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("messages")
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum SenderType {
  CANDIDATE
  AGENT
  TELEOPERATOR
}

// ============================================================================
// ASSESSMENTS (Screening results)
// ============================================================================

model Assessment {
  id              String   @id @default(uuid())
  candidateId     String
  requisitionId   String?

  // Assessment details
  type            AssessmentType
  dimension       String   // e.g., "technical_fit", "culture_fit"

  // Results
  score           Float
  maxScore        Float    @default(100)
  confidence      Float    @default(1.0)

  // Evidence and reasoning
  evidence        Json     @default("[]")   // Supporting evidence
  reasoning       String?  // Agent's reasoning

  // Metadata
  assessedBy      CreatedBy
  assessedAt      DateTime @default(now())

  createdAt       DateTime @default(now())

  // Relations
  candidate       Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@map("assessments")
}

enum AssessmentType {
  RESUME_SCREEN
  SKILLS_MATCH
  EXPERIENCE_FIT
  CULTURE_FIT
  COMMUNICATION
  TECHNICAL_SCREEN
}

// ============================================================================
// INTERACTIONS (Audit trail of all candidate touchpoints)
// ============================================================================

model Interaction {
  id              String   @id @default(uuid())
  candidateId     String

  // Interaction details
  type            InteractionType
  channel         Channel?
  summary         String
  details         Json     @default("{}")

  // Who performed it
  performedBy     CreatedBy
  performedAt     DateTime @default(now())

  // Link to related task
  taskId          String?

  createdAt       DateTime @default(now())

  // Relations
  candidate       Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId, performedAt])
  @@map("interactions")
}

enum InteractionType {
  OUTREACH_SENT
  RESPONSE_RECEIVED
  FOLLOW_UP_SENT
  INTERVIEW_SCHEDULED
  INTERVIEW_COMPLETED
  FEEDBACK_PROVIDED
  STAGE_CHANGED
  NOTE_ADDED
  ASSESSMENT_COMPLETED
}

// ============================================================================
// TASKS - Core of the Two-Loop System
// Sandbox (draft) vs Effectful (requires approval) operations
// ============================================================================

model Task {
  id              String   @id @default(uuid())
  tenantId        String
  requisitionId   String?

  // Task type and payload
  type            TaskType
  payload         Json     // Task-specific data

  // Inner loop tracking
  innerLoopId     String?  // Which inner loop run created this
  iterations      Int      @default(0)
  converged       Boolean  @default(false)

  // Approval workflow
  status          TaskStatus @default(DRAFT)
  effectful       Boolean  @default(false)  // Does this have real-world impact?
  escalationReason EscalationReason?

  // Approval metadata
  approvedBy      String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?

  // Execution
  executedAt      DateTime?
  executionResult Json?
  executionError  String?

  // Priority and scheduling
  priority        Priority @default(MEDIUM)
  scheduledFor    DateTime?
  expiresAt       DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  requisition     JobRequisition? @relation("RequisitionTasks", fields: [requisitionId], references: [id])

  @@index([tenantId, status])
  @@index([tenantId, type])
  @@index([status, scheduledFor])
  @@map("tasks")
}

enum TaskType {
  // Outreach
  SEND_EMAIL
  SEND_LINKEDIN_MESSAGE
  SEND_FOLLOW_UP

  // Sourcing
  SEARCH_CANDIDATES
  IMPORT_CANDIDATE

  // Screening
  SCREEN_RESUME
  GENERATE_ASSESSMENT

  // Scheduling
  SCHEDULE_INTERVIEW
  SEND_REMINDER

  // ATS
  UPDATE_ATS_STATUS
  SYNC_CANDIDATE

  // Offers
  PREPARE_OFFER
  SEND_OFFER

  // Internal
  UPDATE_GUIDELINES
  GENERATE_REPORT
}

enum TaskStatus {
  DRAFT             // Generated by inner loop, not yet queued
  PENDING_APPROVAL  // Awaiting teleoperator review
  APPROVED          // Approved, waiting execution
  EXECUTING         // Currently being executed
  COMPLETED         // Successfully executed
  FAILED            // Execution failed
  REJECTED          // Rejected by teleoperator
  CANCELLED         // Cancelled before execution
  EXPIRED           // Passed expiration time
}

enum EscalationReason {
  SENSITIVE_COMMUNICATION
  BUDGET_DISCUSSION
  OFFER_NEGOTIATION
  CANDIDATE_COMPLAINT
  EDGE_CASE
  LOW_CONFIDENCE
  POLICY_VIOLATION_RISK
  FIRST_CONTACT_VIP
  MANUAL_REVIEW_REQUESTED
}

// ============================================================================
// TELEOPERATOR MANAGEMENT
// ============================================================================

model TeleoperatorAssignment {
  id              String   @id @default(uuid())
  tenantId        String

  // Teleoperator info
  userId          String   // External user ID (from auth system)
  email           String
  name            String
  role            TeleoperatorRole @default(REVIEWER)

  // Status
  status          AssignmentStatus @default(ACTIVE)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@map("teleoperator_assignments")
}

enum TeleoperatorRole {
  REVIEWER        // Can approve/reject tasks
  EDITOR          // Can edit G and C
  ADMIN           // Full access including tenant config
}

enum AssignmentStatus {
  ACTIVE
  INACTIVE
}

// ============================================================================
// INTEGRATIONS
// ============================================================================

model Integration {
  id              String   @id @default(uuid())
  tenantId        String

  // Integration type
  type            IntegrationType
  provider        String   // e.g., "greenhouse", "gmail", "google_calendar"

  // Connection details (encrypted in practice)
  credentials     Json     @default("{}")
  config          Json     @default("{}")

  // Status
  status          IntegrationStatus @default(PENDING)
  lastSyncAt      DateTime?
  lastError       String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, type, provider])
  @@map("integrations")
}

enum IntegrationType {
  ATS
  EMAIL
  CALENDAR
  LINKEDIN
  JOB_BOARD
}

enum IntegrationStatus {
  PENDING
  CONNECTED
  ERROR
  DISCONNECTED
}

// ============================================================================
// ONBOARDING DOCUMENTS
// ============================================================================

model Document {
  id              String   @id @default(uuid())
  tenantId        String

  // Document info
  type            DocumentType
  name            String
  mimeType        String
  storageUrl      String   // S3 or similar

  // Processing status
  status          DocumentStatus @default(PENDING)
  processedAt     DateTime?

  // Extracted content
  extractedContent Json?
  extractedPatterns Json?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, type])
  @@map("documents")
}

enum DocumentType {
  JOB_DESCRIPTION
  COMPANY_INFO
  BRAND_GUIDELINES
  PAST_PLACEMENT
  EMAIL_TEMPLATE
  RECRUITING_PLAYBOOK
  INTERVIEW_GUIDE
}

enum DocumentStatus {
  PENDING
  PROCESSING
  PROCESSED
  FAILED
}

// ============================================================================
// INNER LOOP RUNS (Audit trail of autonomous operations)
// ============================================================================

model InnerLoopRun {
  id              String   @id @default(uuid())
  tenantId        String

  // Context
  taskType        TaskType
  contextSnapshot Json     // Input context for this run

  // Results
  status          InnerLoopStatus @default(RUNNING)
  iterations      Int      @default(0)
  maxIterations   Int      @default(5)

  // Convergence
  converged       Boolean  @default(false)
  finalScore      Float?
  convergenceThreshold Float @default(0.8)

  // Guidelines evolution
  startGuidelinesVersion Int
  endGuidelinesVersion   Int?
  guidelinesUpdates      Json @default("[]")

  // Output
  outputTaskId    String?

  // Timing
  startedAt       DateTime @default(now())
  completedAt     DateTime?

  createdAt       DateTime @default(now())

  @@index([tenantId, createdAt])
  @@index([status])
  @@map("inner_loop_runs")
}

enum InnerLoopStatus {
  RUNNING
  CONVERGED
  MAX_ITERATIONS_REACHED
  ERROR
  CANCELLED
}

// ============================================================================
// RILEY CONVERSATIONS - Track Riley-initiated LinkedIn conversations
// Only auto-respond to conversations that Riley started
// ============================================================================

model RileyConversation {
  id                    String   @id @default(uuid())

  // Unipile identifiers (primary keys for lookup)
  chatId                String   @unique  // Unipile chat ID
  candidateProviderId   String   // LinkedIn provider ID (ACoXXX)

  // Candidate info (denormalized for quick access)
  candidateName         String?
  candidateTitle        String?
  candidateCompany      String?
  candidateProfileUrl   String?

  // Job context
  jobRequisitionId      String?
  jobTitle              String?

  // Conversation state
  stage                 RileyConversationStage @default(INITIAL_OUTREACH)
  status                RileyConversationStatus @default(ACTIVE)

  // Tracking
  messageCount          Int      @default(1)
  lastMessageAt         DateTime @default(now())
  lastMessageBy         LastMessageBy @default(RILEY)

  // Scheduling (goal state)
  schedulingRequested   Boolean  @default(false)
  scheduledCallAt       DateTime?

  // Escalation
  isEscalated           Boolean  @default(false)
  escalationReason      String?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Messages stored separately
  messages              RileyMessage[]

  @@index([chatId])
  @@index([candidateProviderId])
  @@index([status, stage])
  @@map("riley_conversations")
}

model RileyMessage {
  id              String   @id @default(uuid())
  conversationId  String

  role            MessageRole  // RILEY | CANDIDATE | TELEOPERATOR
  content         String

  // Metadata
  unipileMessageId String?
  isAutoGenerated  Boolean @default(false)

  createdAt       DateTime @default(now())

  conversation    RileyConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("riley_messages")
}

enum RileyConversationStage {
  INITIAL_OUTREACH      // First message sent
  AWAITING_RESPONSE     // Waiting for candidate reply
  IN_CONVERSATION       // Back-and-forth happening
  SCHEDULING            // Discussing call scheduling
  SCHEDULED             // Call booked
  FOLLOW_UP             // Following up after no response
  CLOSED_INTERESTED     // Candidate interested, handed off
  CLOSED_NOT_INTERESTED // Candidate declined
  CLOSED_NO_RESPONSE    // No response after follow-ups
}

enum RileyConversationStatus {
  ACTIVE
  PAUSED
  ESCALATED
  COMPLETED
}

enum LastMessageBy {
  RILEY
  CANDIDATE
  TELEOPERATOR
}

enum MessageRole {
  RILEY
  CANDIDATE
  TELEOPERATOR
}
